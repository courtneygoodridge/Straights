---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries}
# rm(list = ls())
library(brms)
library(rtdists)
library(RWiener)

```

data should be loaded from AnalysisRClean script of the 3 test participants.

```{r model formula}

formula <- bf(FirstSteeringTime | dec(response_num) ~ 0 + heading + 
                (0 + heading|p|pNum), 
               bs ~ 0 + heading + (0 + heading|p|pNum), 
               ndt ~ 0 + heading + (0 + heading|p|pNum),
               bias ~ 0 + heading + (0 + heading|p|pNum))


```
Above code sets the model forumula. Specifies reaction time column, response (dec) column. Drift rate is allowed to vary depending on the heading value (original example used two variables that drift can vary by however I really only have one).

bs, ndt and bias are all parameters in the model, that are allowed to vary depending on the heading for each participant. bs is the boundary separtion, ndt is the non-decision time and bias is the starting point

```{r get priors for model parameters}

get_prior(formula,
          data = dat, 
          family = wiener(link_bs = "identity", 
                          link_ndt = "identity", 
                          link_bias = "identity"))

```

```{r priors for nondecision time, boundary and drift rate}

prior <- c(
 prior("cauchy(0, 5)", class = "b"),
 set_prior("normal(1.5, 1)", class = "b", dpar = "bs"),
 set_prior("normal(0.2, 0.1)", class = "b", dpar = "ndt"),
 set_prior("normal(0.5, 0.2)", class = "b", dpar = "bias")
)


```

```{r inspect full model code}
make_stancode(formula, 
              family = wiener(link_bs = "identity", 
                              link_ndt = "identity",
                              link_bias = "identity"),
              data = dat, 
              prior = prior)

```

```{r initial value generator}
tmp_dat <- make_standata(formula, 
                         family = wiener(link_bs = "identity", 
                              link_ndt = "identity",
                              link_bias = "identity"),
                            data = dat, prior = prior)

str(tmp_dat, 1, give.attr = FALSE)


initfun <- function() {
  list(
    b = rnorm(tmp_dat$K),
    b_bs = runif(tmp_dat$K_bs, 1, 2),
    b_ndt = runif(tmp_dat$K_ndt, 0.1, 0.15),
    b_bias = rnorm(tmp_dat$K_bias, 0.5, 0.1),
    sd_1 = runif(tmp_dat$M_1, 0.5, 1),
    z_1 = matrix(rnorm(tmp_dat$M_1*tmp_dat$N_1, 0, 0.01),
                 tmp_dat$M_1, tmp_dat$N_1),
    L_1 = diag(tmp_dat$M_1)
  )
}

```

```{r model estimation}

fit_wiener <- brm(formula, 
                  data = dat,
                  family = wiener(link_bs = "identity", 
                                  link_ndt = "identity",
                                  link_bias = "identity"),
                  prior = prior, inits = initfun,
                  iter = 1000, warmup = 500, 
                  chains = 4, cores = 4, 
                  control = list(max_treedepth = 15))
NPRED <- 500
pred_wiener <- predict(fit_wiener, 
                       summary = FALSE, 
                       negative_rt = TRUE, 
                       nsamples = NPRED)

```

