---
title: "modelling individual participants"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data}
# rm(list = ls())

setwd("C:/Users/pscmgo/OneDrive for Business/PhD/Project/Experiment_Code/Straights")
temp = list.files(pattern = c("magnitudedata", "*.csv")) # list all CSV files in the directory
myfiles = lapply(temp, read.csv) # read these CSV in the directory
magnitudedata <- do.call(rbind.data.frame, myfiles) # convert and combine the CSV files into dataframe

```

```{r load packages}

library(ggplot2)
library(dplyr)
library(car)
library(MASS)
library(dplyr)
library(EnvStats)
library(lme4)
library(nlme)

```

```{r median RT per participant}


magnitudedata <- magnitudedata %>%
  dplyr::filter(heading > 0) # filter out zero headings 

ggplot(magnitudedata %>%
         group_by(pNum, heading) %>%
         summarise(medianRT = median(FirstSteeringTime)), aes(x = heading, y = medianRT)) +
  geom_point() +
  geom_line() +
  facet_wrap(~ pNum)



```

Median RTs across heading seem to be fairly consistent across subjects

```{r fitting of multilevel model using lmer function without gaussian link function}

modellingdata <- magnitudedata %>%
  dplyr::filter(heading > 0) %>% # remove 0 heading trials for modelling data
  mutate(inver_heading = 1/heading) # compute inverse of heading for ease of interpretting intercept

# model 1 - varying intercept
m1 <- lmer(formula = FirstSteeringTime ~ inver_heading + (1 | pNum), data = modellingdata)
summary(m1)
# coef(m1)


# model 2 -  varying intercept and slope
m2 <- lmer(formula = FirstSteeringTime ~ inver_heading + (1 + heading | pNum), data = modellingdata)
summary(m2)
# coef(m2)

```

m1 model formula specifies how FirstSteeringTime is explained by heading. The 1 specifies a varying intercept to vary by participant. coef(m1) shows the different intercepts for each participant. 

m2 model forumula specifies how FirstSteeringTime is explained by heading, except (1 + heading | pNum) allows intercept and slope to vary between participants. coef(m2) shows the different intercepts for each participant.

```{r saving average intercepts and slopes}
# model 1
AvgInterceptm1 <- summary(m1)$coef[1,1]
AvgSlopem1 <- summary(m1)$coef[2,1]

# model 2
AvgInterceptm2 <- summary(m2)$coef[1,1]
AvgSlopem2 <- summary(m2)$coef[2,1]

```

```{r visualising intercepts and slopes for each participant}

interceptsm1 <- coef(m1)$pNum[,1] # Specifying the first column only
slopesm1 <- coef(m1)$pNum[,2] # Specifying the second column only

# fixed effects
ggplot(modellingdata, aes(x = inver_heading, y = FirstSteeringTime, color = as.factor(pNum))) + 
  geom_jitter(alpha = .3) +
  geom_abline(slope = slopesm1, intercept = interceptsm1) +
  # geom_abline(slope = AvgSlopem1, intercept = AvgInterceptm1, color = "red", size = 1, show.legend = TRUE) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_blank()) +
  ggtitle("RTs against heading - varying intercept only")


interceptsm2 <- coef(m2)$pNum[,1] # Specifying the first column only
slopesm2 <- coef(m2)$pNum[,2] # Specifying the second column only

# random effects 
ggplot(modellingdata, aes(x = inver_heading, y = FirstSteeringTime, color = as.factor(pNum))) + 
  geom_jitter(alpha = .3) +
  geom_abline(slope = slopesm2, intercept = interceptsm2) +
  # geom_abline(slope = AvgSlopem2, intercept = AvgInterceptm2, color = "red", size = 1, show.legend = TRUE) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_blank())
  ggtitle("RTs against heading - varying slope and intercept")


# checking intercepts and slopes for individual subjects (unsure how facet_wrap subjectw with their individual intercepts and slopes...)

# ggplot(magnitudedata %>%
#          dplyr::filter(pNum == 7), aes(x = heading, y = FirstSteeringTime, color = as.factor(pNum))) + 
#   geom_jitter(alpha = .3) +
#   geom_abline(slope = slopesm2[7], intercept = interceptsm2[7], alpha = .5) +
#   geom_abline(slope = AvgSlopem2, intercept = AvgInterceptm2, color = "red", size = 1, show.legend = TRUE) +
#   theme(legend.position = "none") +
#   ggtitle("RTs against heading - varying slope and intercept for an individual")

```
For both plots, heading is inverted. This means 2 degrees of heading offset angle is furtherest to the left. This improves interpretation of the intercept, which should be where subejcts are reacting as quickly as possible.

Varying intercept relates to baseline reaction time i.e. latency for how participants react as fast as they can (when error is instantly above threshold). As expected, this varies a lot between participants. In this case, intercept relates to as fast as possible reactions which will naturally vary amongst the population. 

Allowing the intercept and the slope to vary allows you to see if subjects differ in their sensitivity to heading. First plot proposes that variation in RT is based upon the individuals latency. However when we allow the slope is vary, intercepts are very similar thus their latencies are likely to be similar. Differs in RTs between subjects is generated via their different sensitivies to the heading explanatory variable. For example, the lowest line proposes that the effect of heading is not that strong whereas the highest line proposes that for that subjectm heading had a large affect on RTs, despite them both having similar baseline reaction times.

```{r model comparions}

anova(m1, m2)

```
We can then compare the models by computing a chi squared test. They significantly differ from each other. Model 2 also has lower AIC value, suggesting that it is the best model in explaining the data (i.e. subject variation in sensitivity to the heading).

```{r histogram and density plots}

ggplot() + 
  geom_density(aes(x = slopesm1), col = "blue", show.legend = TRUE) +
  geom_density(aes(x = slopesm2), col = "red", show.legend = TRUE) +
  xlab("slope") +
  ggtitle("Slope density plots")
  

ggplot() + 
  geom_density(aes(x = interceptsm1), col = "blue", show.legend = TRUE) +
  geom_density(aes(x = interceptsm2), col = "red", show.legend = TRUE) +
  xlab("intercept") +
  ggtitle("Slope density plots")

```
**Slope density pplots**

Blue indicates model 1, red line indicates model 2. When we allow the model to vary the slope per participant, the variance of the slope increases (participant sensitivity to heading differs for each participant). However when the slope does not differ between participants, it assumes they have been drawn from a normal distribution.

**Intercept density plots**

Blue indicates model 1, red line indicates model 2. Model 1 allowed for a varying intercept, thus the density is more spread over the positive values. In contrast, when we allow the slope to vary by heading for each subject, the intercepts clusters around zero as the variation in RTs is better explained by the differences in sensitivity in heading between participants rather than baseline latency.