---
title: "Time and yaw rate change"
output: html_document
---

```{r setup, include=FALSE}
# chooseCRANmirror(graphics=FALSE, ind=1) # uncomment for knitting
# rm(list = ls()) # clear workspace
knitr::opts_chunk$set(echo = TRUE)
install.packages(ggplot2)
install.packages(dplyr)
install.packages(tidyr)
install.packages(matlab)
# install.packages("magrittr")
setwd("M:/PhD/Project/Experiment_Code/Straights") # set working directory
temp = list.files(pattern = "*.csv") # list all CSV files in the directory
myfiles = lapply(temp, read.csv) # read these CSV in the directory
workingdata <- do.call(rbind.data.frame, myfiles) # convert and combine the CSV files into dataframe

```

```{r obtaining thresholds}
library(dplyr)

# change in steering threshold
yawratechange_threshold = 0.1

YRchange <- workingdata$YawRate_seconds - c(0,workingdata$YawRate_seconds[-length(workingdata$YawRate_seconds)]) # calculating difference in yawrate

YRchange <- data.frame(YRchange) # convert yaw rate to dataframe

colnames(YRchange) <- c("YawRateChange") # change column names

workingdata <- cbind(workingdata, YRchange) # join dataframes

# determine first time in each ppid for each trialn
first_time <- workingdata %>%
  group_by(ppid,trialn) %>% 
  filter(row_number() == 1) %>% 
  ungroup()  %>% 
  transmute(ppid, heading, trialn, cameraoffset, SWAStart = SWA, TrialStart = timestamp, StartWorld_x = World_x, StartWorld_z = World_z, StartWorldYaw = WorldYaw, StartYawRate_seconds = YawRate_seconds, StartYawRateChange = YawRateChange) #use transmute to rename nwly computed variable (TrialStart) future join, ungroup first to allow for column rename of grouping variable

# determine first time in each ppid, trialn group above threshold 
threshold <-workingdata %>%
  group_by(ppid,trialn) %>%
  filter(abs(YawRateChange) > yawratechange_threshold) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  transmute(ppid, heading, trialn, cameraoffset, SWAThres = SWA, FirstYawRateChangeTimeThres = timestamp, ThresWorld_x = World_x, ThresWorld_z = World_z, ThresWorldYaw = WorldYaw, ThresYawRate_seconds = YawRate_seconds, ThresYawRateChange = YawRateChange) #use transmute to rename for future join, ungroup first to allow for column rename of grouping variable

# Here SWA angle is redundent as it only takes the SWA for when the change in yaw rate is over the threshold... I'm interested in ThresYawRateChange (first change in yaw rate over threhsold) and FirstYawRateChangeTimeThres (first timestamp where yaw rate change is over threshold).

# produce final result set with ppid, trialn, first time, and first time above yaw rate change threshold
workingdatafinal <- left_join(first_time, threshold, by = c("ppid", "heading", "cameraoffset", "trialn")) %>%
  mutate(FirstSteeringTime = FirstYawRateChangeTimeThres - TrialStart) # calculate final result: first timestamp where change in yaw rate is over threshold minus starting trial timestamp

#Only thing extra would be to calculate frame rate (ask Richard), and then multiply by change in yaw rate to get yaw rate per second per second.

```

For the following plots, I have filtered the data by heading angle. To calcuate the total trial time, I have subtract the trial starting time from the trial ending trial for each trial (giving me the trial time for each trial) and the sum these together to get the about of time for heading angle

Then to create a timecourse, I calculate a linearly spaced column (TrialTime) from 0 to the calculated heading trial time containing the same number of values as there are frames.

I then plot a line graph with the TrialTime on the x axis, and YawRateChange on the y axis. 

```{r timecourse plotting, echo=FALSE}


library(ggplot2)
library(dplyr)
library(tidyr)
library(matlab)

# -1 heading

minus1 <- workingdata %>%
  filter(heading < 0 & heading > -2) # filters just -1 heading

newdata <- minus1 %>% group_by(ppid, trialn) %>%
  filter(timestamp<=min(timestamp)+4) %>%
  ungroup() # generates 4 seconds of data from the start of the trial

newdata <- unite(newdata, ppid_trialn, ppid, trialn, sep = "_") # creates unique ID for trial and ppid in order to plot together

ggplot(newdata, aes(x = timestamp, y = YawRateChange, colour = ppid_trialn)) +
  geom_line() # plots all -1 headings but on a long time scale. Needs to be 4 second scale with data plotted on top of each other

newdata <- newdata %>% group_by(ppid, trialn) %>% mutate(rownum = row_number())

trialtimesminus1 <- minus1 %>%
  group_by(trialn) %>%
  summarise(trialtimes = tail(timestamp, n =1) - head(timestamp, n = 1))

minus1trialtotal <- sum(trialtimesminus1$trialtimes)

minus1total <- linspace(0, minus1trialtotal, n = 8179)
minus1total <- data.frame(minus1total)
colnames(minus1total) <- c("TrialTime")
minus1 <- cbind(minus1, minus1total)
ggplot(minus1, aes(x = TrialTime, y = YawRateChange)) +
  geom_line() +
  ggtitle("-1 heading")

# -2 heading 

minus2 <- workingdata %>%
  filter(heading < -1)

trialtimesminus2 <- minus2 %>%
  group_by(trialn) %>%
  summarise(trialtimes = tail(timestamp, n =1) - head(timestamp, n = 1))

minus2trialtotal <- sum(trialtimesminus2$trialtimes)

minus2total <- linspace(0, minus2trialtotal, n = 8175)
minus2total <- data.frame(minus2total)
colnames(minus2total) <- c("TrialTime")
minus2 <- cbind(minus2, minus2total)
ggplot(minus2, aes(x = TrialTime, y = YawRateChange)) +
  geom_line() +
  ggtitle("-2 heading")

# +1 heading

plus1 <- workingdata %>%
  filter(heading > 0 & heading < 2)

trialtimesplus1 <- plus1 %>%
  group_by(trialn) %>%
  summarise(trialtimes = tail(timestamp, n =1) - head(timestamp, n = 1))

plus1trialtotal <- sum(trialtimesplus1$trialtimes)

plus1total <- linspace(0, plus1trialtotal, n = 8177)
plus1total <- data.frame(plus1total)
colnames(plus1total) <- c("TrialTime")
plus1 <- cbind(plus1, plus1total)
ggplot(plus1, aes(x = TrialTime, y = YawRateChange)) +
  geom_line() +
  ggtitle("+1 heading")

# +2 heading

plus2 <- workingdata %>%
  filter(heading > 1)

trialtimesplus2 <- plus2 %>%
  group_by(trialn) %>%
  summarise(trialtimes = tail(timestamp, n =1) - head(timestamp, n = 1))

plus2trialtotal <- sum(trialtimesplus2$trialtimes)

plus2total <- linspace(0, plus2trialtotal, n = 8188)
plus2total <- data.frame(plus2total)
colnames(plus2total) <- c("TrialTime")
plus2 <- cbind(plus2, plus2total)
ggplot(plus2, aes(x = TrialTime, y = YawRateChange)) +
  geom_line() +
  ggtitle("+2 heading")

```

