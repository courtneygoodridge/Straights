---
title: "AnalysisRNewThreshold_Timestamp"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# chooseCRANmirror(graphics=FALSE, ind=1) # uncomment for knitting
# rm(list = ls()) # clear workspace
install.packages(ggplot2)
install.packages(dplyr)
install.packages(tidyr)
install.packages(TTR)
install.packages(zoo)
install.packages(matlab)
# install.packages("magrittr")
setwd("M:/PhD/Project/Experiment_Code/Straights") # set working directory
# setwd("C:/Users/Courtney/Documents/PhD/Project/Experiment_code/Straights")
temp = list.files(pattern = "*.csv") # list all CSV files in the directory
myfiles = lapply(temp, read.csv) # read these CSV in the directory
workingdata <- do.call(rbind.data.frame, myfiles) # convert and combine the CSV files into dataframe
```

```{r calculating row numbers - FOR RICHARD}
library(dplyr)
library(tidyr)

workingdata <- unite(workingdata, ppid_trialn, ppid, trialn, sep = "_") # create unique ppid_trialn ID

rows <- workingdata %>%
  group_by(ppid_trialn) %>%
  summarise(rows = n())
View(rows)

```


```{r thresholds, clipping data, calculating yaw rate change, removing spikes}
library(tidyr)
library(dplyr)
library(matlab)

# change in steering threshold
upperthreshold = 0.105 # 0.2184 # upper threshold for consistent steering response
lowerthreshold = 0.010 # lower threshold for when response initiated 

# workingdata <- unite(workingdata, ppid_trialn, ppid, trialn, sep = "_") # create unique ppid_trialn ID

workingdata <- workingdata %>%
    mutate(YawRateChange = YawRate_seconds - c(0, YawRate_seconds[-length(YawRate_seconds)])) # calculating difference in yawrate

workingdata <- workingdata %>%
  group_by(ppid_trialn) %>% 
  filter(n() == 273) %>%
  ungroup() # filtering for trials without missing frames

workingdata <- workingdata %>%
  group_by(ppid_trialn) %>%
  mutate(anchored_timestamp = timestamp - min(timestamp)) %>%
  filter(anchored_timestamp<=min(anchored_timestamp)+4) %>%
  filter(n() == 241) %>% # clipping timecourse at 4 seconds
  ungroup()

workingdata <- workingdata %>%
  group_by(ppid_trialn) %>%
  mutate(CORRECTEDanchored_timestamp = linspace(0, 4, 241)) %>%
  ungroup() # creating new timestamp variable to match frames

```

In the previous way I calculated the timestamp, I couldn't create an average timecourse for each heading as each increment in the timestamp was different due to a differing number of frames in each trial. They only differed slightly but it was enough to throw the whole thing off.

Above, I have devised a way to get rond this. Keep the majority of trials that have the correct number of frames (113/150 have 273 frames). I then clip the timecourse to the firt 4 seconds. I then construct a new timestamp using linspace to create a timecourse from 0-4, linearly spaced for the number of frames. 

This means each increment from 0-4 is the same, so I can average each data point at each time point to get an overall average.

Line plots remain the same shape. Mean values and boxplots differ slightly, but the direction of the relationship is still the same - just that I've removed some data from the sample. 

The timestamp also makes sense as the frame rate is 60 frames per second in the experiment, and every second 60 frames (rows of data) are created. Also 241/60 is 4.01666667 - i.e. 4 seconds of data that I'm using.

```{r calculating number of trials per condition overall - FOR RICHARD}
library(ggplot2)
library(dplyr)

pptsoverall <- workingdata %>%
  group_by(heading, ppid_trialn) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(heading) %>%
  summarise(NoOfPpts = n()) %>%
  ungroup()

sum(pptsoverall$NoOfPpts) # number of trials remaiing after filtering consistent frame rates

View(pptsoverall)

```


```{r formulating threshold data}
library(zoo)
library(dplyr)
library(tidyr)
library(TTR)

workingdatathresholdUnsmooth <- workingdata %>%
  group_by(ppid_trialn)%>%
  mutate(row_number())%>% # added to verify selection
  filter(max(abs(YawRateChange)) > upperthreshold, # filter largest yaw rate change greater than the upper threshold
         min(abs(YawRateChange)) < lowerthreshold) %>% # filter lowest yaw rate change smaller than the lower theshold
  slice(1:min(which(abs(YawRateChange) > upperthreshold))) %>% 
  slice(max(which(abs(YawRateChange) < lowerthreshold))) %>% # which() returns rows where a condition is true. Taking the min() of all the rows that are greater than the criteria will return the first row where that is true.
  ungroup() %>%
  transmute(ppid_trialn, heading, cameraoffset, SWAThres = SWA, FirstSteeringTime = anchored_timestamp, ThresWorld_x = World_x, ThresWorld_z = World_z, ThresWorldYaw = WorldYaw, ThresYawRate_seconds = YawRate_seconds, ThresYawRateChange = YawRateChange)

##################################### SMOOTHING DATA ###################################

# workingdatatimecourseSmooth <- workingdatatimecourseUnsmooth %>%
#   mutate(smoothedYawRateChange = SMA(YawRateChange, n = 1)) # calculates moving average over the number of data points you specify
# 
# workingdatatimecourseSmooth[is.na(workingdatatimecourseSmooth)] <- 0 # set NA values to 0. This is because smoothing data in this way creates NA values if you don't have enough to average over. Unsure how else to get around this
# 
# # determine first time in each ppid, trialn group above threshold
# workingdatathresholdSmooth <- workingdatatimecourseSmooth %>%
#   group_by(ppid_trialn)%>%
#   mutate(row_number())%>% # added to verify selection
#   filter(max(abs(smoothedYawRateChange)) > upperthreshold, # filter largest yaw rate change greater than the upper threshold
#          min(abs(smoothedYawRateChange)) < lowerthreshold) %>% # filter lowest yaw rate change smaller than the lower theshold
#   slice(1:min(which(abs(smoothedYawRateChange) > upperthreshold))) %>%
#   slice(max(which(abs(smoothedYawRateChange) < lowerthreshold))) %>% # which() returns rows where a condition is true. Taking the min() of all the rows that are greater than the criteria will return the first row where that is true.
#   ungroup() %>%
#   transmute(ppid_trialn, heading, cameraoffset, SWAThres = SWA, FirstSteeringTime = anchored_timestamp, ThresWorld_x = World_x, ThresWorld_z = World_z, ThresWorldYaw = WorldYaw, ThresYawRate_seconds = YawRate_seconds, ThresYawRateChange = smoothedYawRateChange)

##################################### SMOOTHING DATA ###################################

# Here SWA angle is redundent as it only takes the SWA for when the change in yaw rate is over the threshold... I'm interested in ThresYawRateChange (first change in yaw rate over threhsold) and FirstYawRateChangeTimeThres (first timestamp where yaw rate change is over threshold).

#Only thing extra would be to calculate frame rate (60 frames) (ask Richard), and then multiply by change in yaw rate to get yaw rate per second per second.

```

```{r calculating number of trials per condition that reach threshold - FOR RICHARD}
library(ggplot2)
library(dplyr)

pptsthreshold <- workingdatathresholdUnsmooth %>%
  group_by(heading) %>%
  summarise(NoOfPpts = n())

sum(pptsthreshold$NoOfPpts) # number of trials that reach threshold

View(pptsthreshold)

```

```{r timecourse plotting of yaw rate change}
library(ggplot2)
library(dplyr)

# workingdatathresholdUnsmooth <- workingdatathresholdUnsmooth %>%
#   filter(FirstSteeringTime < 1.25) # filter outliers 

######## -2 heading ##########

ggplot(data = filter(workingdata, heading == -2), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == -2) %>%
               summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
  ggtitle("-2 heading - unsmoothed") +
  scale_y_continuous(limits = c(-0.50, 0.75))

# ggplot(data = filter(workingdatatimecourseSmooth, heading == -2), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == -2) %>%
#                summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
#   ggtitle("-2 heading - smoothed") +
#   scale_y_continuous(limits = c(-0.50, 0.75))

######## -1 heading ##########

ggplot(data = filter(workingdata, heading == -1), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == -1) %>%
               summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
  ggtitle("-1 heading - unsmoothed") +
  scale_y_continuous(limits = c(-0.50, 0.75))

# ggplot(data = filter(workingdatatimecourseSmooth, heading == -1), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == -1) %>%
#                summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
#   ggtitle("-1 heading - smoothed") +
#   scale_y_continuous(limits = c(-0.50, 0.75))

######## 0 heading ##########

ggplot(data = filter(workingdata, heading == 0), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == 0) %>%
               summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
  ggtitle("0 heading - unsmoothed") +
  scale_y_continuous(limits = c(-0.50, 0.75))

# ggplot(data = filter(workingdatatimecourseSmooth, heading == 0), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == 0) %>%
#                summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
#   ggtitle("0 heading - smoothed") +
#   scale_y_continuous(limits = c(-0.50, 0.75))

######## +1 heading ##########

ggplot(data = filter(workingdata, heading == 1), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == 1) %>%
               summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
  ggtitle("+1 heading - unsmoothed") +
  scale_y_continuous(limits = c(-0.50, 0.75))

# ggplot(data = filter(workingdatatimecourseSmooth, heading == 1), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == 1) %>%
#                summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
#   ggtitle("+1 heading - smoothed") +
#   scale_y_continuous(limits = c(-0.50, 0.75))

######## +2 heading ##########

ggplot(data = filter(workingdata, heading == 2), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == 2) %>%
               summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
  ggtitle("+2 heading - unsmoothed") +
  scale_y_continuous(limits = c(-0.50, 0.75))

# ggplot(data = filter(workingdatatimecourseSmooth, heading == 2), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange, colour = ppid_trialn)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == 2) %>%
#                summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE)), aes(xintercept = meanFirstSteeringTime)) +
#   ggtitle("+2 heading - smoothed") +
#   scale_y_continuous(limits = c(-0.50, 0.75))

```


```{r timecourse plotting for individual trials}
library(ggplot2)
library(dplyr)

##### -2 ######

ggplot(data = filter(workingdata, heading == -2), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == -2), aes(xintercept = FirstSteeringTime), col = "red") +
  facet_wrap( ~ ppid_trialn) +
  scale_y_continuous(limits = c(-0.60, 0.80)) +
  ggtitle("-2 heading - unsmoothed")

# ggplot(data = filter(workingdatatimecourseSmooth, heading == -2), aes(x = CORRECTEDanchored_timestamp, y = smoothedYawRateChange)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == -2), aes(xintercept = FirstSteeringTime), col = "red") +
#   facet_wrap( ~ ppid_trialn) +
#   scale_y_continuous(limits = c(-0.60, 0.80)) +
#   ggtitle("-2 heading - smoothered")

##### -1 ######

ggplot(data = filter(workingdata, heading == -1), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == -1), aes(xintercept = FirstSteeringTime), col = "red") +
  facet_wrap( ~ ppid_trialn) +
  scale_y_continuous(limits = c(-0.60, 0.80)) +
  ggtitle("-1 heading - unsmoothered")

# ggplot(data = filter(workingdatatimecourseSmooth, heading == -1), aes(x = CORRECTEDanchored_timestamp, y = smoothedYawRateChange)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == -1), aes(xintercept = FirstSteeringTime), col = "red") +
#   facet_wrap( ~ ppid_trialn) +
#   scale_y_continuous(limits = c(-0.60, 0.80)) +
#   ggtitle("-1 heading - smoothered")

#### 0 ########

ggplot(data = filter(workingdata, heading == 0), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == 0), aes(xintercept = FirstSteeringTime), col = "red") +
  facet_wrap( ~ ppid_trialn) +
  scale_y_continuous(limits = c(-0.60, 0.80)) +
  ggtitle("0 heading - unsmoothed")

# ggplot(data = filter(workingdatatimecourseSmooth, heading == 0), aes(x = CORRECTEDanchored_timestamp, y = smoothedYawRateChange)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == 0), aes(xintercept = FirstSteeringTime), col = "red") +
#   facet_wrap( ~ ppid_trialn) +
#   scale_y_continuous(limits = c(-0.60, 0.80)) +
#   ggtitle("0 heading - smoothed")

###### +1 ######

ggplot(data = filter(workingdata, heading == 1), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == 1), aes(xintercept = FirstSteeringTime), col = "red") +
  facet_wrap( ~ ppid_trialn) +
  scale_y_continuous(limits = c(-0.60, 0.80)) +
  ggtitle("+1 heading - unsmoothed")

# ggplot(data = filter(workingdatatimecourseSmooth, heading == 1), aes(x = CORRECTEDanchored_timestamp, y = smoothedYawRateChange)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == 1), aes(xintercept = FirstSteeringTime), col = "red") +
#   facet_wrap( ~ ppid_trialn) +
#   scale_y_continuous(limits = c(-0.60, 0.80)) +
#   ggtitle("+1 heading - smoothed")

##### +2 #####

ggplot(data = filter(workingdata, heading == 2), aes(x = CORRECTEDanchored_timestamp, y = YawRateChange)) +
  geom_line() +
  geom_vline(data = filter(workingdatathresholdUnsmooth, heading == 2), aes(xintercept = FirstSteeringTime), col = "red") +
  facet_wrap( ~ ppid_trialn) +
  scale_y_continuous(limits = c(-0.60, 0.80)) +
  ggtitle("+2 heading - unsmoothed")

# ggplot(data = filter(workingdatatimecourseSmooth, heading == 2), aes(x = CORRECTEDanchored_timestamp, y = smoothedYawRateChange)) +
#   geom_line() +
#   geom_vline(data = filter(workingdatathresholdSmooth, heading == 2), aes(xintercept = FirstSteeringTime), col = "red") +
#   facet_wrap( ~ ppid_trialn) +
#   scale_y_continuous(limits = c(-0.60, 0.80)) +
#   ggtitle("+2 heading - smoothed")

```


```{r mean first steering adjustment}
library(dplyr)

workingdatathresholdUnsmooth %>%
  group_by(heading) %>%
  summarise(meanFirstSteeringTime = mean(FirstSteeringTime, na.rm = TRUE))

```

```{r boxplots for all angles}
library(dplyr)
library(ggplot2)

ggplot(workingdatathresholdUnsmooth, aes(as.factor(heading), FirstSteeringTime)) +
  geom_boxplot() +
  ggtitle("First steering time across heading angles: boxplots") +
  xlab("Heading angle (degrees)") +
  ylab("Time until first steering correction (s)")
  
```

```{r average timecourse for each heading}
library(ggplot2)
library(dplyr)

ggplot(data = workingdata %>%
         filter(heading == -2) %>%
         group_by(CORRECTEDanchored_timestamp) %>%
         summarise(meanYawRateChange = mean(YawRateChange)), aes(x = CORRECTEDanchored_timestamp, y = meanYawRateChange)) +
  geom_line() +
  ggtitle("Average yaw rate change timecourse for -2 heading condition") +
  scale_y_continuous(limits = c(-0.25, 0.25))


ggplot(data = workingdata %>%
         filter(heading == -1) %>%
         group_by(CORRECTEDanchored_timestamp) %>%
         summarise(meanYawRateChange = mean(YawRateChange)), aes(x = CORRECTEDanchored_timestamp, y = meanYawRateChange)) +
  geom_line() +
  ggtitle("Average yaw rate change timecourse for -1 heading condition") +
  scale_y_continuous(limits = c(-0.25, 0.25))


ggplot(data = workingdata %>%
         filter(heading == 0) %>%
         group_by(CORRECTEDanchored_timestamp) %>%
         summarise(meanYawRateChange = mean(YawRateChange)), aes(x = CORRECTEDanchored_timestamp, y = meanYawRateChange)) +
  geom_line() +
  ggtitle("Average yaw rate change timecourse for 0 heading condition") +
  scale_y_continuous(limits = c(-0.25, 0.25))


ggplot(data = workingdata %>%
         filter(heading == 1) %>%
         group_by(CORRECTEDanchored_timestamp) %>%
         summarise(meanYawRateChange = mean(YawRateChange)), aes(x = CORRECTEDanchored_timestamp, y = meanYawRateChange)) +
  geom_line() +
  ggtitle("Average yaw rate change timecourse for +1 heading condition") +
  scale_y_continuous(limits = c(-0.25, 0.25))


ggplot(data = workingdata %>%
         filter(heading == 2) %>%
         group_by(CORRECTEDanchored_timestamp) %>%
         summarise(meanYawRateChange = mean(YawRateChange)), aes(x = CORRECTEDanchored_timestamp, y = meanYawRateChange)) +
  geom_line() +
  ggtitle("Average yaw rate change timecourse for +2 heading condition") +
  scale_y_continuous(limits = c(-0.25, 0.25))



```